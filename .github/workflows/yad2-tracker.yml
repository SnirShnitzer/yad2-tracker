name: Yad2 Tracker

on:
  # Run every hour
  schedule:
    - cron: '0 * * * *'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode (no emails)'
        required: false
        default: false
        type: boolean

  # DISABLED: Run on push to main branch (for testing)
  # push:
  #   branches: [ main, master ]
  #   paths-ignore:
  #     - 'admin-web/**'

jobs:
  track-listings:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history to ensure we have the latest code
      
    - name: Verify latest code
      run: |
        echo "üìã Current commit: $(git rev-parse HEAD)"
        echo "üìÖ Last commit date: $(git log -1 --format=%cd)"
        echo "üìù Last commit message: $(git log -1 --format=%s)"
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'tracker-service/package-lock.json'
        
    - name: Install dependencies
      run: |
        cd tracker-service
        npm ci
        # Fix for undici compatibility issues
        npm install --save-dev @types/node@18
      
    - name: Build TypeScript
      run: |
        cd tracker-service
        npm run build
      
    - name: Test Database Connection
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        NODE_OPTIONS: --no-experimental-fetch --dns-result-order=ipv4first
        PGSSLMODE: require
        PGCONNECT_TIMEOUT: 30
      run: |
        cd tracker-service
        echo "üîç Testing database connection..."
        node -e "
        import { Pool } from 'pg';
        
        // Parse connection string for session pooler
        const url = new URL(process.env.DATABASE_URL);
        const pool = new Pool({
          host: url.hostname,
          port: parseInt(url.port) || 5432,
          database: url.pathname.slice(1),
          user: url.username,
          password: url.password,
          ssl: { rejectUnauthorized: false },
          connectionTimeoutMillis: 30000,
          application_name: 'yad2-tracker-test'
        });
        
        try {
          const client = await pool.connect();
          await client.query('SELECT 1');
          client.release();
          await pool.end();
          console.log('‚úÖ Database connection successful');
        } catch (error) {
          console.error('‚ùå Database connection failed:', error.message);
          process.exit(1);
        }
        "
      
    - name: Run Yad2 Tracker
      env:
        GMAIL_USER: ${{ secrets.GMAIL_USER }}
        GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        SEND_EMAILS: ${{ secrets.SEND_EMAILS || 'true' }}
        EMAIL_RECIPIENTS: ${{ secrets.EMAIL_RECIPIENTS }}
        NODE_ENV: production
        TEST_MODE: ${{ github.event.inputs.test_mode || 'false' }}
        # Force IPv4 to avoid GitHub Actions IPv6 connectivity issues
        NODE_OPTIONS: --no-experimental-fetch --dns-result-order=ipv4first
        # Additional environment variables to help with connectivity
        PGSSLMODE: require
        PGCONNECT_TIMEOUT: 30
        # Supabase connection settings for IPv4 compatibility
        SUPABASE_DB_POOLER: true
        SUPABASE_DB_IPV4_ONLY: true
      run: |
        cd tracker-service
        echo "üîß Environment check:"
        echo "  - DATABASE_URL: ${DATABASE_URL:0:30}..."
        echo "  - EMAIL_RECIPIENTS: ${EMAIL_RECIPIENTS:+configured}"
        echo "  - NODE_OPTIONS: $NODE_OPTIONS"
        echo "  - PGSSLMODE: $PGSSLMODE"
        echo "  - SUPABASE_DB_POOLER: $SUPABASE_DB_POOLER"
        echo ""
        if [ "$TEST_MODE" = "true" ]; then
          echo "üß™ Running in test mode - no emails will be sent"
          node dist/index.js
        else
          echo "üöÄ Running Yad2 Tracker with email notifications"
          node dist/index.js
        fi
        
    - name: Upload logs (if any errors)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: error-logs
        path: |
          tracker-service/*.log
          tracker-service/seen_ads.json
